<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduCare | Parent â€¢ Attendance Overview</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase + Data Layer -->
  <script type="module" src="../admin/educare-data-firebase.js"></script>
  <script type="module" src="../firebase/firebase-init.js"></script>
  <script src="../firebase/firestore-sync.js"></script>

  
  <!-- Parent theme -->
  <link rel="stylesheet" href="parent-theme.css">
</head>

<body class="parent-portal page-attendance">
  <aside class="sidebar">
    <div class="brand">EduCare</div>
    <nav class="nav">
      <div class="radio-container" style="--total-radio:6">
        <input type="radio" id="nav-dashboard" name="parent-nav" />
        <label for="nav-dashboard" onclick="location.href='dashboard.html'">Dashboard</label>

        <input type="radio" id="nav-academic" name="parent-nav" />
        <label for="nav-academic" onclick="location.href='academic.html'">Academic</label>

        <input type="radio" id="nav-attendance" name="parent-nav" checked />
        <label for="nav-attendance" onclick="location.href='attendance.html'">Attendance</label>

        <input type="radio" id="nav-counseling" name="parent-nav" />
        <label for="nav-counseling" onclick="location.href='counseling.html'">Counseling Feedback</label>

        <input type="radio" id="nav-chat" name="parent-nav" />
        <label for="nav-chat" onclick="location.href='chat.html'">Communication</label>

        <input type="radio" id="nav-profile" name="parent-nav" />
        <label for="nav-profile" onclick="location.href='profile.html'">Profile</label>

        <div class="glider-container"><div class="glider"></div></div>
      </div>
    </nav>
  </aside>

  <main class="main">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1>Attendance Overview</h1>
        <p style="color:#f7f9fc">Detailed monthly attendance of your child and overall summary.</p>
      </div>
      <div class="header-controls">
        <!-- Notification button moved from sidebar into main header -->
        <button class="notif-button" id="notifBtn" aria-expanded="false" aria-controls="notifPanel" title="Notifications">
          <span class="notif-icon">ðŸ””</span>
          <span class="notif-text" style="display:none">Notifications</span>
        </button>
      </div>
    </div>

    <table id="attTable" class="att-glow">
      <thead>
        <tr><th>Month</th><th>Total Working Days</th><th>Days Present</th><th>Attendance %</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="graph-wrap green-graph">
      <canvas id="attChart" class="att-chart"></canvas>
    </div>
    <div class="insights" id="attInsights"></div>
  </main>

  <script src="../admin/admin.js"></script>
  <script src="parent.js"></script>
  <script src="parent-theme.js"></script>

  <script>
    const sampleAtt = [
      {month:'Jan', total:22, present:21},
      {month:'Feb', total:20, present:17},
      {month:'Mar', total:23, present:19},
      {month:'Apr', total:21, present:18},
      {month:'May', total:20, present:16},
      {month:'Jun', total:18, present:14}
    ];

    function getAttendanceForStudent(s){
      if(!s) return sampleAtt;
      if(Array.isArray(s.attendanceRecords) && s.attendanceRecords.length) return s.attendanceRecords;
      return sampleAtt;
    }

    function render(){
      const p = EduCareParent.getCurrentParent?.();
      if(!p) return;
      const s = EduCareParent.getLinkedStudent?.();
      if(!s) return;

      const attData = getAttendanceForStudent(s);
      const tbody = document.querySelector('#attTable tbody');
      tbody.innerHTML = attData.map(a=>{
        const percent = a.total ? ((Number(a.present||0) / Number(a.total||1)) * 100).toFixed(1) : '0.0';
        return `<tr><td>${a.month}</td><td>${a.total}</td><td>${a.present}</td><td>${percent}%</td></tr>`;
      }).join('');

      const ctx = document.getElementById('attChart');
      if(window._attChart) window._attChart.destroy?.();
      window._attChart = new Chart(ctx,{
        type:'line',
        data:{
          labels:attData.map(a=>a.month),
          datasets:[{
                label:'Attendance %',
                data:attData.map(a=> a.total ? ((Number(a.present||0)/Number(a.total||1))*100).toFixed(1) : 0),
                borderColor:'#059669',
                backgroundColor:'rgba(16,185,129,0.12)'
              }]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}}
      });

      const avg = attData.length ? (
        attData.reduce((acc,b)=> acc + (b.total ? ((Number(b.present||0)/Number(b.total||1))*100) : 0),0) / attData.length
      ) : 0;

      let advice='';
      if(avg < 75)
        advice=`âš ï¸ Attendance is quite low (${avg.toFixed(1)}%). Please encourage regular attendance to avoid academic issues.`;
      else if(avg < 85)
        advice=`ðŸŸ¡ Attendance is moderate (${avg.toFixed(1)}%). Staying consistent will improve performance and reduce stress.`;
      else
        advice=`âœ… Excellent! ${s.name || 'Student'}'s attendance rate of ${avg.toFixed(1)}% is commendable.`;

      document.getElementById('attInsights').innerHTML = `
        <h3>Attendance Insights</h3>
        <p>${advice}</p>
        <p style="color:#6b7280">System Recorded Attendance: ${s.attendance || avg.toFixed(1)}%</p>
      `;
    }

    if(EduCareParent.ensureParentSelected?.()) render();
    else window.addEventListener('parent-ready', render,{once:true});
    if(window.EduCareAdmin?.onStoreUpdated) EduCareAdmin.onStoreUpdated(render);

    // Notification button behavior
    (function(){
      const btn = document.getElementById('notifBtn');
      if(!btn) return;
      // Create panel element and append to body
      let panel = document.getElementById('notifPanel');
      if(!panel){
        panel = document.createElement('div');
        panel.id = 'notifPanel';
        panel.className = 'notif-panel';
        panel.innerHTML = `
          <h4>Notifications</h4>
          <div class="notif-item">No new notifications<small>â€” You're all caught up</small></div>
        `;
        document.body.appendChild(panel);
      }

      // State: 0 = icon mode, 1 = text mode
      btn.dataset.mode = btn.dataset.mode || '0';

      btn.addEventListener('click', function(e){
        const mode = btn.dataset.mode;
        if(mode === '0'){
          // switch to text-only: remove icon, reveal text span
          btn.classList.add('text-only');
          const icon = btn.querySelector('.notif-icon'); if(icon) icon.style.display = 'none';
          const text = btn.querySelector('.notif-text'); if(text) text.style.display = 'inline';
          btn.dataset.mode = '1';
          btn.setAttribute('aria-expanded','false');
          return;
        }

        // if already in text mode, toggle panel
        const open = panel.classList.toggle('open');
        panel.setAttribute('aria-hidden', open ? 'false' : 'true');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });

      // Close panel when clicking outside
      document.addEventListener('click', function(e){
        if(!panel.classList.contains('open')) return;
        if(e.target === btn || btn.contains(e.target) || panel.contains(e.target)) return;
        panel.classList.remove('open');
        panel.setAttribute('aria-hidden','true');
        btn.setAttribute('aria-expanded','false');
      });
    })();
  </script>
</body>
</html>
