<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduCare | Parent â€¢ Communication</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Load Firebase + data layer FIRST -->
  <script type="module" src="../admin/educare-data-firebase.js"></script>
  <script type="module" src="../firebase/firebase-init.js"></script>
  <script src="../firebase/firestore-sync.js"></script>

<script type="module">
  import { EduCareData } from "../admin/educare-data-firebase.js";

  async function loadStudents() {
    const students = await EduCareData.list("students");
    const grid = document.getElementById("studentGrid");
    if (!grid) return;
    const hideNames = ['Ravi Kumar','Anjali Sharma','Vikram Singh','Unnamed','Aarush Nair','Mihika Sharma','Dev Patel','Ananya Reddy','Kabir Verma','SU1'];
    const hidePins = ['20A91A001','20A91A002','20A91A003','797025','23CS001','23EC002','23IT003','23ME004','23CV005','126'];
    const visible = (students || []).filter(s => {
      const name = (s.name || '').trim();
      const pin = String(s.pin || '').trim();
      if(name && hideNames.includes(name)) return false;
      if(pin && hidePins.includes(pin)) return false;
      return true;
    });
    grid.innerHTML = visible.map(s => `
      <div class="card"> 
        <div class="name">${s.name}</div>
        <div class="meta">PIN: ${s.pin || '-'} | CGPA: ${s.cgpa ?? '-'}</div>
        <button onclick="showStudent('${s.id}')">View</button>
      </div>
    `).join('');
  }

  async function showStudent(id) {
    const st = await EduCareData.getById("students", id);
    // TODO: render st into the DOM
  }

  async function createSession({ studentId, counselorId, date, notes, outcome }) {
    await EduCareData.addSession({ studentId, counselorId, date, notes, outcome });
  }

  async function updateCounselor(id, payload) {
    await EduCareData.update("counselors", id, payload);
  }

  // Kick off initial load:
  loadStudents();
</script>

  <div id="studentGrid" style="display:none"></div>

  <!-- Parent theme -->
  <link rel="stylesheet" href="parent-theme.css">

  
  </head>
  <body class="parent-portal page-chat">
  <aside class="sidebar">
    <div class="brand">EduCare</div>
    <nav class="nav">
      <div class="radio-container" style="--total-radio:6">
        <input type="radio" id="nav-dashboard" name="parent-nav" />
        <label for="nav-dashboard" onclick="location.href='dashboard.html'">Dashboard</label>

        <input type="radio" id="nav-academic" name="parent-nav" />
        <label for="nav-academic" onclick="location.href='academic.html'">Academic</label>

        <input type="radio" id="nav-attendance" name="parent-nav" />
        <label for="nav-attendance" onclick="location.href='attendance.html'">Attendance</label>

        <input type="radio" id="nav-counseling" name="parent-nav" />
        <label for="nav-counseling" onclick="location.href='counseling.html'">Counseling Feedback</label>

        <input type="radio" id="nav-chat" name="parent-nav" checked />
        <label for="nav-chat" onclick="location.href='chat.html'">Communication</label>

        <input type="radio" id="nav-profile" name="parent-nav" />
        <label for="nav-profile" onclick="location.href='profile.html'">Profile</label>

        <div class="glider-container"><div class="glider"></div></div>
      </div>
    </nav>
  </aside>

  <main class="main">
    <div class="page-header" style="display:flex;align-items:center;justify-content:flex-start;gap:12px">
      <div><h1 id="headerTitle">Chat</h1></div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="sendBox">
      <input id="msgInput" placeholder="Type your message to the counselor..." />
      <button id="sendBtn">Send</button>
    </div>
  </main>

  <script src="../admin/admin.js"></script>
  <script src="parent.js"></script>
  <script src="parent-theme.js"></script>
  <script>
    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const headerTitle = document.getElementById('headerTitle');

    function key(){ 
      const c = EduCareParent.getLinkedCounselor();
      return `${c.id}|parent|${EduCareParent.getCurrentParent()?.id||EduCareParent.getCurrentParent()?.ID||''}`;
    }

    function render(){
      const p = EduCareParent.getCurrentParent();
      if(!p) return;
      const s = EduCareParent.getLinkedStudent();
      const c = EduCareParent.getLinkedCounselor();

      if(!s || !c){
        messagesDiv.innerHTML = '<p style="color:#6b7280">No counselor linked yet.</p>';
        headerTitle.textContent = 'Chat';
        return;
      }

      headerTitle.textContent = `Chat with ${c.name}`;
      // Ensure messages render in chronological order (oldest first)
      const thread = (EduCareParent.getChatThread() || []).slice().sort((a,b)=> new Date(a.at) - new Date(b.at));
      messagesDiv.innerHTML = thread.map(m => {
        const cls = m.from === 'parent' ? 'from-me' : 'from-them';
        const time = m.at ? `<small>${EduCareParent.fmtDate(m.at)}</small>` : '';
        return `<div class="msg ${cls}">${m.text}${time}</div>`;
      }).join('');
      // scroll to bottom so newest message is visible
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    sendBtn.onclick = ()=>{
      const text = msgInput.value.trim();
      if(!text) return;
      EduCareParent.sendMessageToCounselor(text);
      // Simulated counselor reply for demo
      setTimeout(()=>{
        const c = EduCareParent.getLinkedCounselor();
        if(!c) return;
        const store = JSON.parse(localStorage.getItem('educare_chat_threads_v1') || '{"threads":{}}');
        const k = `${c.id}|parent|${EduCareParent.getCurrentParent()?.id||EduCareParent.getCurrentParent()?.ID||''}`;
        store.threads[k] = store.threads[k] || [];
        store.threads[k].push({from:'counselor', text:'Thanks for reaching out. I will follow up.', at:new Date().toISOString()});
        localStorage.setItem('educare_chat_threads_v1', JSON.stringify(store));
        render();
      }, 1200);
      msgInput.value = '';
      render();
    };

    // Enter to send
    msgInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendBtn.click();
      }
    });

    // enable/disable send button based on input
    function updateSendState(){ sendBtn.disabled = !msgInput.value.trim(); }
    msgInput.addEventListener('input', updateSendState);
    updateSendState();

    if(EduCareParent.ensureParentSelected()) render();
    else window.addEventListener('parent-ready', render, {once:true});
  </script>
</body>
</html>
